<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T5 RezervÄƒri</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: #dfeaed;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar {
      background: #2b4450;
      width: 380px;
      height: 520px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, .3);
      transition: transform .8s ease;
      transform-style: preserve-3d;
      position: relative;
    }

    .front, .back {
      position: absolute;
      width: 100%;
      height: 100%;
      color: #fff;
      backface-visibility: hidden;
      border-radius: 8px;
    }

    .front { transform: rotateY(0deg); }
    .back  { transform: rotateY(180deg); background: #2b4450; }
    .calendar.flip { transform: rotateY(180deg); }

    .header {
      padding: 20px 30px;
      border-bottom: 1px solid rgba(255,255,255,.2);
      text-align: center;
      position: relative;
    }

    .header h1 { font-size: 1.4em; color: #dfebed; }

    #myResBtn {
      position: absolute;
      top: 20px;
      right: 25px;
      background: #f78536;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.85em;
      transition: background .2s;
    }

    #myResBtn:hover { background: #ff974d; }

    .weekdays {
      display: flex;
      justify-content: space-between;
      color: #dfebed;
      font-weight: 600;
      padding: 15px 25px;
    }

    .days {
      display: flex;
      flex-wrap: wrap;
      padding: 10px 25px;
    }

    .days span {
      width: 14%;
      text-align: center;
      margin: 5px 0;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background .2s;
    }

    .days span:hover  { background: #497285; }
    .days span.active { background: #f78536; }
    .days span.past   { opacity: .4; cursor: not-allowed; }

    .back h2 {
      text-align: center;
      padding: 15px 0;
      font-weight: 400;
    }

    .slots {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      padding: 10px;
      overflow-y: auto;
      height: 390px;
      justify-items: center;
    }

    .slot {
      width: 55px;
      height: 55px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      transition: transform .2s;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }

    .slot:hover { transform: scale(1.07); }
    .slot.full  { cursor: not-allowed; opacity: 0.6; box-shadow: none; }

    .back button {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 0;
      background: #f78536;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background .2s;
    }

    .back button:hover { background: #ff974d; }
  </style>
</head>

<body>
  <div class="calendar" id="cal">
    <div class="front">
      <div class="header">
        <h1 id="luna"></h1>
        <h1 id="an" style="font-size:1em;opacity:.7"></h1>
        <button id="myResBtn">RezervÄƒrile mele</button>
      </div>
      <div class="weekdays">
        <span>Lu</span><span>Ma</span><span>Mi</span><span>Jo</span>
        <span>Vi</span><span>SÃ¢</span><span>Du</span>
      </div>
      <div class="days" id="zile"></div>
    </div>

    <div class="back">
      <h2 id="dataSelectata">Data aleasÄƒ</h2>
      <div class="slots" id="ore"></div>
      <button id="back">ÃŽnapoi</button>
    </div>
  </div>

  <script>
    const BASE = window.location.origin;
    const luni = ["Ianuarie","Februarie","Martie","Aprilie","Mai","Iunie",
                  "Iulie","August","Septembrie","Octombrie","Noiembrie","Decembrie"];
    const cal = document.getElementById("cal"),
          zile = document.getElementById("zile"),
          ore = document.getElementById("ore"),
          lunaLbl = document.getElementById("luna"),
          anLbl = document.getElementById("an"),
          dataLbl = document.getElementById("dataSelectata");

    let curenta = new Date(), currentDate = null;

    function arataCalendar() {
      const luna = curenta.getMonth(), an = curenta.getFullYear();
      lunaLbl.textContent = luni[luna]; anLbl.textContent = an; zile.innerHTML = "";
      const prima = new Date(an, luna, 1).getDay() || 7, ultima = new Date(an, luna + 1, 0).getDate();
      const azi = new Date(); azi.setHours(0,0,0,0);

      for (let i = 1; i < prima; i++) {
        const gol = document.createElement("span");
        gol.style.opacity = ".3";
        zile.appendChild(gol);
      }

      for (let d = 1; d <= ultima; d++) {
        const s = document.createElement("span");
        s.textContent = d;
        const data = new Date(an, luna, d);
        data.setHours(0,0,0,0);
        if (data < azi) s.classList.add("past");
        else s.onclick = () => deschide(an, luna, d);
        zile.appendChild(s);
      }
    }

    async function deschide(an, luna, zi) {
      const data = `${an}-${String(luna+1).padStart(2,'0')}-${String(zi).padStart(2,'0')}`;
      dataLbl.textContent = `${zi} ${luni[luna]} ${an}`;
      cal.classList.add("flip");
      currentDate = data;
      await incarcaOre(data);
    }

    async function incarcaOre(data) {
      ore.innerHTML = "<p style='color:#dfebed;'>Se Ã®ncarcÄƒ...</p>";
      try {
        const res = await fetch(`${BASE}/api/timeslots?date=${data}`, { credentials: "include" });
        const info = await res.json();
        renderOre(info.timeslots);
      } catch {
        ore.innerHTML = "<p style='color:red'>Eroare la Ã®ncÄƒrcare</p>";
      }
    }

    function culoareGrad(nrOcupate) {
      const culori = ["#27ae60", "#2ecc71aa", "#f1c40f", "#e67e22", "#e74c3c"];
      return culori[nrOcupate] || "#27ae60";
    }

    function renderOre(slots) {
      ore.innerHTML = "";
      slots.forEach(s => {
        const ocupate = s.machines.filter(m => m.booked).length;
        const full = ocupate === 4;
        const div = document.createElement("div");
        div.className = `slot ${full ? 'full' : ''}`;
        div.textContent = s.time;
        div.style.background = culoareGrad(ocupate);
        if (!full) div.onclick = () => alegeMasina(s);
        ore.appendChild(div);
      });
    }

    async function alegeMasina(slot) {
      const html = slot.machines.map(m =>
        m.booked
          ? `<button class="swal2-confirm swal2-styled" disabled
              style="margin:5px;background:#ddd;color:#e74c3c;font-weight:bold;cursor:not-allowed;">
              ${m.booked_by || ''}</button>`
          : `<button class="swal2-confirm swal2-styled"
              onclick="window.selectMachine('${slot.time}','${m.name}')"
              style="margin:5px;background:#3085d6;">${m.name}</button>`
      ).join('');
      await Swal.fire({ title:`Alege maÈ™ina pentru ora ${slot.time}`, html, showConfirmButton:false });
    }

    window.selectMachine = async (time, machine) => {
      const camera = localStorage.getItem("camera");
      if (!camera) return Swal.fire("Eroare","Camera nu este setatÄƒ!","error");

      const confirm = await Swal.fire({
        title: "Confirmi rezervarea?",
        text: `${machine} la ora ${time} pe ${currentDate}`,
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Da",
        cancelButtonText: "Nu"
      });
      if (confirm.isConfirmed) await rezervare(currentDate, time, machine, camera);
    };

    async function rezervare(date, time, machine, room) {
      try {
        const res = await fetch(`${BASE}/api/book`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({date, time, machine, room}),
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          await Swal.fire("Succes","Rezervare efectuatÄƒ!","success");
          await incarcaOre(date);
        } else Swal.fire("Eroare", data.error, "error");
      } catch {
        Swal.fire("Eroare","Serverul nu rÄƒspunde","error");
      }
    }

    // ðŸ”¹ Buton RezervÄƒrile mele
    document.getElementById("myResBtn").addEventListener("click", async () => {
      try {
        const res = await fetch(`${BASE}/api/my_reservations`, { credentials: "include" });
        const data = await res.json();
        if (!data.reservations.length)
          return Swal.fire("Nicio rezervare","Nu ai nicio rezervare activÄƒ.","info");
        const html = data.reservations
          .map(r => `<div style='padding:6px 0;border-bottom:1px solid #eee;'>
                      <b>${r.date}</b> â€” ${r.time}, ${r.machine}</div>`)
          .join("");
        Swal.fire({ title:"RezervÄƒrile mele", html, width:350, confirmButtonText:"OK" });
      } catch {
        Swal.fire("Eroare","Serverul nu rÄƒspunde.","error");
      }
    });

    document.getElementById("back").addEventListener("click", () => cal.classList.remove("flip"));
    arataCalendar();
  </script>
</body>
</html>
