<script>
const BASE = window.location.origin;
const luni = ["Ianuarie","Februarie","Martie","Aprilie","Mai","Iunie","Iulie","August","Septembrie","Octombrie","Noiembrie","Decembrie"];
const cal = document.getElementById("cal"), zile = document.getElementById("zile"), ore = document.getElementById("ore");
const lunaLbl = document.getElementById("luna"), anLbl = document.getElementById("an"), dataLbl = document.getElementById("dataSelectata");
let curenta = new Date(), currentDate = null;

// --- Calendar principal ---
function arataCalendar() {
  const luna = curenta.getMonth(), an = curenta.getFullYear();
  lunaLbl.textContent = luni[luna]; anLbl.textContent = an; zile.innerHTML = "";
  const prima = new Date(an, luna, 1).getDay() || 7, ultima = new Date(an, luna + 1, 0).getDate(), azi = new Date();
  azi.setHours(0,0,0,0);
  for (let i = 1; i < prima; i++) zile.appendChild(document.createElement("span"));
  for (let d = 1; d <= ultima; d++) {
    const s = document.createElement("span"); s.textContent = d;
    const data = new Date(an, luna, d); data.setHours(0,0,0,0);
    if (data < azi) s.classList.add("past"); else s.onclick = () => deschide(an, luna, d);
    zile.appendChild(s);
  }
}

// --- Deschide ziua selectată ---
async function deschide(an, luna, zi) {
  const data = `${String(zi).padStart(2,'0')}-${String(luna+1).padStart(2,'0')}-${an}`;
  dataLbl.textContent = `${zi} ${luni[luna]} ${an}`;
  cal.classList.add("flip"); currentDate = data;
  await incarcaOre(data);
}

// --- Încarcă orele și mașinile ---
async function incarcaOre(data) {
  ore.innerHTML = "<p style='color:#dfebed;'>Se încarcă...</p>";
  try {
    const res = await fetch(`${BASE}/api/timeslots?date=${data}`, { credentials: "include" });
    const info = await res.json();
    renderOre(info.timeslots);
  } catch { ore.innerHTML = "<p style='color:red'>Eroare la încărcare</p>"; }
}

// --- Culoare în funcție de gradul de ocupare ---
function culoareGrad(nrOcupate) {
  const culori = ["#27ae60","#2ecc71aa","#f1c40f","#e67e22","#e74c3c"];
  return culori[Math.min(nrOcupate, 4)];
}

// --- Afișează grila de ore ---
function renderOre(slots) {
  ore.innerHTML = "";
  slots.forEach(slot => {
    const ocupate = slot.machines.filter(m => m.booked).length;
    const full = ocupate === 4;
    const div = document.createElement("div");
    div.className = `slot ${full ? 'full' : ''}`;
    div.textContent = slot.time;
    div.style.background = culoareGrad(ocupate);
    if (!full) div.onclick = () => alegeMasina(slot);
    ore.appendChild(div);
  });
}

// --- Alege mașina ---
async function alegeMasina(slot) {
  const html = slot.machines.map((m,i) => {
    if (m.booked) {
      return `<button class='swal2-confirm swal2-styled' disabled
              style='margin:5px;background:#e74c3c;color:white;cursor:not-allowed;font-weight:bold;'>
              ${m.booked_by || m.room || ''}
              </button>`;
    } else {
      return `<button class='swal2-confirm swal2-styled'
              onclick="window.selectMachine('${slot.time}','M${i+1}')"
              style='margin:5px;background:#3085d6;'>Mașina ${i+1}</button>`;
    }
  }).join('');
  await Swal.fire({ title: `Alege mașina pentru ora ${slot.time}`, html, showConfirmButton: false });
}

// --- Confirmare rezervare ---
window.selectMachine = async (time, machine) => {
  const camera = localStorage.getItem("camera");
  if (!camera) return Swal.fire("Eroare", "Camera nu este setată!", "error");
  const confirm = await Swal.fire({
    title: "Confirmi rezervarea?",
    text: `${machine} la ora ${time} pe ${currentDate}`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Da",
    cancelButtonText: "Nu"
  });
  if (confirm.isConfirmed) await rezervare(currentDate, time, machine, camera);
};

// --- Trimite rezervarea ---
async function rezervare(date, time, machine, room) {
  try {
    const res = await fetch(`${BASE}/api/book`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({date, time, machine, room}),
      credentials: "include"
    });
    const data = await res.json();
    if (data.success) {
      await Swal.fire("Succes", "Rezervare efectuată!", "success");
      await incarcaOre(date);
    } else Swal.fire("Eroare", data.error, "error");
  } catch { Swal.fire("Eroare", "Serverul nu răspunde", "error"); }
}

// --- Rezervările mele ---
async function showMyReservations() {
  try {
    const res = await fetch(`${BASE}/api/my_reservations`, { credentials: "include" });
    const data = await res.json();
    if (!data.success || !data.reservations.length)
      return Swal.fire("Info", "Nu ai rezervări active.", "info");

    const html = data.reservations.map(r => `
      <div style='padding:6px 0;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;font-size:14px;'>
        <span><b>${r.date}</b> — ${r.time}, ${r.machine} (<span style='color:#777;'>${r.room}</span>)</span>
        <button onclick="deleteReservation(${r.id})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:16px;">✕</button>
      </div>
    `).join("");
    Swal.fire({ title: "Rezervările mele", html, confirmButtonText: "OK" });
  } catch {
    Swal.fire("Eroare", "Nu s-au putut încărca rezervările.", "error");
  }
}

// --- Ștergere rezervare ---
async function deleteReservation(id) {
  const conf = await Swal.fire({
    title: "Ștergi această rezervare?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Da",
    cancelButtonText: "Nu"
  });
  if (!conf.isConfirmed) return;
  try {
    const res = await fetch(`${BASE}/api/delete_reservation`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      credentials: "include",
      body: JSON.stringify({ id })
    });
    const data = await res.json();
    if (data.success) {
      Swal.fire("Ștearsă!", "Rezervarea a fost ștearsă.", "success");
      showMyReservations();
      await incarcaOre(currentDate);
    } else Swal.fire("Eroare", data.error, "error");
  } catch { Swal.fire("Eroare", "Serverul nu răspunde.", "error"); }
}

document.getElementById("back").addEventListener("click", () => cal.classList.remove("flip"));
arataCalendar();
</script>
